version: '3.8'

services:


  # MinIO Object Storage
  minio:
    image: quay.io/minio/minio:latest
    container_name: d3_minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: HoangPhatCs
      MINIO_ROOT_PASSWORD: 25092005=))
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - d3_network

  # DÂ³ API Application
  d3_api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: d3_api
    restart: always
    environment:
      
      # MinIO
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: HoangPhatCs
      MINIO_SECRET_KEY: 25092005=))
      MINIO_SECURE: "False"
      MINIO_BUCKET: deepfake-results
      
      # Model
      MODEL_CHECKPOINT_PATH: /app/checkpoints/finetune_wildrf/model_epoch_best.pth
      MODEL_TYPE: d3_clip
      DEVICE: cuda
      CONFIDENCE_THRESHOLD: 0.5
      
      # Flask
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 6000
      FLASK_DEBUG: "False"
      FLASK_THREADED: "True"
      
      # Other
      SECRET_KEY: 24560012
      DEBUG: "False"
      API_VERSION: v1.0
      LOG_LEVEL: INFO
      MAX_CONTENT_LENGTH: 104857600
      UPLOAD_FOLDER: /app/api/uploads
    
    ports:
      - "6000:6000"
    
    volumes:
      # Mount model checkpoint (read-only)
      - ./checkpoints:/app/checkpoints:ro
      # Mount uploads (temporary)
      - ./api/uploads:/app/api/uploads
      # Mount logs
      - ./logs:/app/logs
    
    depends_on:
      # postgres:
      #   condition: service_healthy
      minio:
        condition: service_healthy
    
    networks:
      - d3_network
    
    # GPU support (optional - requires nvidia-docker)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # MinIO Client (for bucket initialization)
  minio_init:
    image: minio/mc:latest
    container_name: d3_minio_init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://minio:9000 HoangPhatCs '25092005=))';
      /usr/bin/mc mb myminio/deepfake-results --ignore-existing;
      /usr/bin/mc anonymous set download myminio/deepfake-results;
      echo 'MinIO bucket initialized successfully';
      exit 0;
      "
    networks:
      - d3_network

volumes:
  minio_data:
    driver: local

networks:
  d3_network:
    driver: bridge