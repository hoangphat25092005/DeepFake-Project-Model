# ğŸ­ DÂ³ Deepfake Detection API

![Python](https://img.shields.io/badge/python-3.8+-blue.svg)
![PyTorch](https://img.shields.io/badge/PyTorch-2.0.1-red.svg)
![CUDA](https://img.shields.io/badge/CUDA-11.8%20%7C%2012.8-green.svg)
![Flask](https://img.shields.io/badge/Flask-3.0.0-black.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

Production-ready REST API for deepfake detection using the DÂ³-CLIP ViT-L/14 model, featuring MongoDB Atlas storage, MinIO object storage, and GPU-accelerated inference.

## ğŸ“‹ Table of Contents

- [Features](#-features)
- [Architecture](#-architecture)
- [Requirements](#-requirements)
- [Installation](#-installation)
- [Configuration](#-configuration)
- [Deployment](#-deployment)
- [API Endpoints](#-api-endpoints)
- [Usage Examples](#-usage-examples)
- [Monitoring](#-monitoring)
- [Troubleshooting](#-troubleshooting)
- [Contributing](#-contributing)

## âœ¨ Features

### Core Capabilities
- **ğŸ¯ State-of-the-art Detection**: DÂ³-CLIP ViT-L/14 model fine-tuned on WildRF dataset
- **âš¡ GPU Acceleration**: Supports NVIDIA RTX A4000 with CUDA 11.8/12.8
- **ğŸ“Š Single & Batch Processing**: Handle one image or multiple images efficiently
- **â˜ï¸ Cloud-Ready**: MongoDB Atlas integration for scalable storage
- **ğŸ’¾ Object Storage**: MinIO for secure result image storage
- **ğŸ“ Comprehensive Logging**: Detailed logs for debugging and monitoring
- **ğŸ”’ Production Ready**: Error handling, validation, and health checks

### API Features
- **RESTful Design**: Clean, intuitive API endpoints
- **Swagger UI**: Interactive API documentation at `/apidocs`
- **Real-time Health Checks**: Monitor API status
- **Prediction History**: Query past predictions
- **Statistics Dashboard**: API usage metrics

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Client Application         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP/REST
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Flask API (Port 5001)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Route Handlers             â”‚   â”‚
â”‚  â”‚   - /predict                 â”‚   â”‚
â”‚  â”‚   - /predict/batch           â”‚   â”‚
â”‚  â”‚   - /predictions/*           â”‚   â”‚
â”‚  â”‚   - /health                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Service Layer              â”‚   â”‚
â”‚  â”‚   - ModelService (GPU)       â”‚   â”‚
â”‚  â”‚   - DatabaseService          â”‚   â”‚
â”‚  â”‚   - StorageService           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   DÂ³-CLIP Model              â”‚   â”‚
â”‚  â”‚   ViT-L/14 Architecture      â”‚   â”‚
â”‚  â”‚   Fine-tuned on WildRF       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB    â”‚   â”‚    MinIO     â”‚
â”‚  Atlas      â”‚   â”‚  (Port 9000) â”‚
â”‚  (Cloud)    â”‚   â”‚  Local/Cloud â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Component | Technology | Version |
|-----------|-----------|---------|
| **Backend** | Flask | 3.0.0 |
| **WSGI Server** | Gunicorn | 21.2.0 |
| **Deep Learning** | PyTorch | 2.0.1 |
| **Model** | CLIP ViT-L/14 | - |
| **Database** | MongoDB Atlas | 4.6+ |
| **Object Storage** | MinIO | Latest |
| **API Docs** | Flasgger | 0.9.7.1 |
| **CUDA** | 11.8 / 12.8 | - |

## ğŸ’» Requirements

### Hardware
- **GPU**: NVIDIA RTX A4000 (16GB VRAM) or equivalent
  - Minimum: GPU with 8GB+ VRAM
  - CPU mode available (slower inference)
- **RAM**: 16GB+ recommended
- **Storage**: 10GB+ for model and dependencies

### Software
- **OS**: Linux (Ubuntu 22.04 LTS recommended)
- **Python**: 3.8, 3.9, or 3.10
- **CUDA**: 11.8 or 12.8
- **NVIDIA Drivers**: 470+ (for CUDA support)

### Accounts (Optional but Recommended)
- **MongoDB Atlas**: Free tier available at [mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
- **MinIO**: Can run locally (no account needed)

## ğŸ“¦ Installation

### Option 1: Manual Installation (Recommended for Development)

#### Step 1: Clone Repository

```bash
git clone https://github.com/hoangphat25092005/DeepFake-Project-Model.git
cd DeepFake-Project-Model/api
```

#### Step 2: Create Python Environment

```bash
# Using conda (recommended)
conda create -n d3_api python=3.10
conda activate d3_api

# Or using venv
python -m venv venv
source venv/bin/activate  # Linux/Mac
```

#### Step 3: Install Dependencies

```bash
# Core dependencies
pip install flask==3.0.0
pip install flask-cors==4.0.0
pip install flasgger==0.9.7.1
pip install gunicorn==21.2.0
pip install python-dotenv==1.0.0

# Database
pip install pymongo==4.6.1
pip install dnspython==2.6.1

# Storage
pip install minio==7.2.0

# Image processing
pip install Pillow==10.1.0
pip install opencv-python==4.8.1.78

# Deep Learning (CUDA 11.8)
pip install torch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 --index-url https://download.pytorch.org/whl/cu118

# Additional ML libraries
pip install timm==0.9.12
pip install ftfy==6.1.3
pip install regex==2023.10.3
```

#### Step 4: Install MinIO (No Sudo Required)

```bash
# Download MinIO to user bin directory
mkdir -p ~/bin
wget https://dl.min.io/server/minio/release/linux-amd64/minio -O ~/bin/minio
chmod +x ~/bin/minio

# Add to PATH
echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# Verify installation
minio --version
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=your_bucket_name

# Model
MODEL_CHECKPOINT_PATH=your_model_checkpoint
DEVICE=cpu  # or cuda if your system support

# Flask
FLASK_HOST=0.0.0.0
FLASK_PORT=5000
FLASK_DEBUG=True
```

### 4. Start MinIO

```bash
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v ~/minio/data:/data \
  quay.io/minio/minio server /data --console-address ":9001"
```

### 5. Initialize Database

```bash
cd api
bash init_database.sh
```

### 6. Run API

```bash
cd /path/to/D3
python api/app.py
```

API will be available at:
- **API**: http://localhost:5000
- **Swagger Docs**: http://localhost:5000/docs
- **MinIO Console**: http://localhost:9001

## API Documentation

### Health Check

```bash
GET /health
```

### Single Prediction

```bash
POST /predict
Content-Type: multipart/form-data

{
  "image": <file>
}
```

### Batch Prediction

```bash
POST /batch_predict
Content-Type: multipart/form-data

{
  "images": <file[]>
}
```

### Database Queries

```bash
GET /api/db/predictions/recent?limit=10
GET /api/db/predictions/{id}
GET /api/db/predictions/by-label/FAKE
GET /api/db/statistics
```

## Testing

```bash
# Health check
curl http://localhost:5000/health

# Single prediction
curl -X POST -F "image=@test.jpg" http://localhost:5000/predict

# Get recent predictions
curl http://localhost:5000/api/db/predictions/recent

# Get statistics
curl http://localhost:5000/api/db/statistics
```

## Project Structure

```
D3/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ app.py                  # Main application
â”‚   â”œâ”€â”€ config.py               # Configuration
â”‚   â”œâ”€â”€ .env                    # Environment variables
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                 # API routes
â”‚   â”‚   â”œâ”€â”€ health_check_route.py
â”‚   â”‚   â”œâ”€â”€ prediction_route.py
â”‚   â”‚   â””â”€â”€ database_route.py
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # Business logic
â”‚   â”‚   â”œâ”€â”€ minio_service.py
â”‚   â”‚   â””â”€â”€ database_service.py
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # Database models
â”‚   â”‚   â””â”€â”€ prediction.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # Utilities
â”‚       â””â”€â”€ model_loader.py
â”‚
â”œâ”€â”€ models/                     # ML model architecture
â”œâ”€â”€ checkpoints/                # Model weights (not in git)
â””â”€â”€ requirements.txt
```

## ğŸ› ï¸ Development

### Install Development Dependencies

```bash
pip install -r requirements-dev.txt
```

### Run Tests

```bash
pytest tests/
```

### Code Formatting

```bash
black api/
flake8 api/
```

## Database Schema

### predictions table
- `id`: Primary key
- `original_filename`: Original image name
- `result_filename`: Result image name
- `minio_url`: MinIO presigned URL
- `label`: REAL or FAKE
- `confidence`: Prediction confidence
- `created_at`: Timestamp

### prediction_batches table
- `id`: Primary key
- `batch_id`: Unique batch identifier
- `total_images`: Number of images
- `successful`: Successful predictions
- `failed`: Failed predictions

## Configuration

See [`.env.example`](api/.env.example) for all configuration options.

## License

MIT License

## Contributors

- Hoang Phat (@hoangphat25092005)

## Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## Contact

- GitHub: [@hoangphat25092005](https://github.com/hoangphat25092005)
- Project: [DeepFake-Project-Model](https://github.com/hoangphat25092005/DeepFake-Project-Model)

## Acknowledgments

- DÂ³ (Diverse Deepfake Detection) research
- OpenAI CLIP architecture
- Flask framework
- MinIO object storage